require 'stringio'
require 'test/unit'

class EngineSchematic
  NUMBER = /\d+/
  SPECIAL = /[#\$\*]/

  def initialize(schematic)
    @schematic = schematic
    @part_numbers = []
    @non_parts = []
    collect_parts
  end

  attr_reader :part_numbers, :non_parts

  private

  def collect_parts
    @previous_line = Line.new(nil)
    @current_line = Line.new(@schematic.readline)
    @next_line = Line.new(@schematic.readline)
    collect_parts_from_line

    until @next_line.empty?
      @previous_line = @current_line
      @current_line = @next_line
      @next_line = Line.new(@schematic.eof ? nil : @schematic.readline)
      collect_parts_from_line
    end
  end

  def collect_parts_from_line
    @current_line.scan(/\d+/) do |match|
      next unless match

      match_start = @current_line.last_match.pre_match.length

      search_for_part_indicator(match, match_start)
    end
  end

  def search_for_part_indicator(match, match_start)
    match_end = match_start + match.length
    start_position = match_start - 1
    end_position = match_end
    [@current_line, @previous_line, @next_line].each do |line|
      (start_position..end_position).each do |index|
        next unless line.part_at?(index)

        puts "Match: #{match} at #{index} in #{line.string} is #{line.at(index)}"
        @part_numbers << match.to_i
        return
      end
    end
  end

  class Line
    def initialize(line_string)
      @line_string = line_string&.strip
      @last_match = nil
    end

    attr_reader :last_match

    def empty?
      @line_string.nil?
    end

    def string
      @line_string
    end

    def at(index)
      return nil if empty?
      return nil if index.negative? || index >= @line_string.length

      @line_string[index]
    end

    def part_at?(index)
      return false if at(index).nil?

      at(index).match(/\W/) && !at(index).match(/\d|\./)
    end

    def scan(*args, &block)
      return if empty?
      @line_string.scan(*args) do |match|
        @last_match = ::Regexp.last_match
        block.call(match)
      end
    end
  end
end

class Day3Test < Test::Unit::TestCase
  def setup
    @schematic = <<~TEXT
      467..114..
      ...*......
      ..35..633.
      ......#...
      617*......
      .....+.58.
      ..592.....
      ......755.
      ...$.*....
      .664.598..
    TEXT
  end

  def test_schematic
    schematic = EngineSchematic.new(StringIO.new(@schematic))
    assert(schematic.part_numbers.include?(467))
    assert(schematic.part_numbers.include?(35))
    assert(schematic.part_numbers.include?(633))
    assert(schematic.part_numbers.include?(592))
    assert(schematic.part_numbers.include?(755))
    assert(schematic.part_numbers.include?(664))
    assert(schematic.part_numbers.include?(598))

    assert(!schematic.part_numbers.include?(114))
    assert(!schematic.part_numbers.include?(58))

    assert_equal(8, schematic.part_numbers.size)
  end

  def test_another
    s = <<~TEXT
      ......................................*.........841....*....../................+..311.......................441..........*...........202....
      .........332...60....537..697.......901.................609....678....261.....90................870....519...........272..449.......%.......
      840.........*...........*....*..968......273...440.415..................*..................&......*...*......447................883...&.....
    TEXT
    schematic = EngineSchematic.new(StringIO.new(s))
    assert_equal([
                   202, 332, 537, 697, 901, 609, 678, 261, 90, 870, 519, 449
                 ], schematic.part_numbers)
  end

end

file = File.new("#{File.dirname(__FILE__)}/input.txt")
schematic = EngineSchematic.new(file)
puts "Parts: #{schematic.part_numbers}"
puts "Sum: #{schematic.part_numbers.sum}"

# too high
# Parts: [501, 168, 202, 332, 537, 697, 901, 609, 678, 261, 90, 870, 519, 272, 449, 968, 273, 440, 415, 447, 883, 34, 651, 786, 646, 804, 96, 760, 222, 637, 290, 565, 518, 717, 80, 231, 610, 810, 942, 640, 499, 189, 550, 626, 676, 213, 432, 995, 955, 391, 387, 825, 362, 481, 579, 84, 506, 700, 170, 733, 658, 832, 777, 915, 322, 526, 852, 410, 14, 28, 831, 586, 69, 30, 505, 274, 344, 52, 308, 123, 504, 15, 968, 427, 439, 456, 935, 441, 195, 794, 786, 476, 168, 653, 148, 962, 271, 23, 435, 491, 4, 40, 26, 758, 957, 372, 894, 661, 283, 421, 946, 668, 886, 30, 682, 108, 292, 189, 759, 379, 380, 942, 891, 193, 946, 39, 847, 80, 886, 418, 763, 432, 873, 916, 335, 369, 651, 624, 445, 809, 695, 267, 666, 641, 888, 38, 685, 149, 312, 27, 544, 420, 750, 208, 361, 569, 986, 295, 751, 499, 549, 626, 390, 761, 319, 289, 250, 189, 947, 804, 742, 660, 342, 582, 24, 611, 354, 997, 595, 874, 109, 108, 252, 168, 88, 973, 161, 499, 497, 52, 83, 5, 739, 156, 88, 798, 444, 974, 108, 39, 651, 395, 963, 911, 886, 532, 417, 921, 82, 321, 597, 321, 409, 254, 237, 308, 954, 110, 478, 423, 990, 429, 506, 614, 575, 893, 13, 811, 673, 85, 465, 393, 782, 166, 831, 401, 348, 477, 819, 261, 761, 536, 427, 924, 283, 795, 617, 954, 248, 407, 756, 986, 326, 516, 387, 336, 142, 354, 233, 523, 336, 495, 856, 363, 188, 177, 4, 512, 835, 458, 348, 445, 638, 214, 190, 293, 128, 711, 565, 842, 195, 984, 201, 530, 640, 289, 251, 626, 198, 277, 964, 397, 910, 936, 893, 249, 334, 299, 503, 918, 420, 405, 910, 892, 76, 511, 674, 282, 418, 962, 693, 760, 499, 908, 926, 906, 485, 564, 132, 137, 300, 960, 503, 572, 490, 608, 979, 25, 925, 673, 433, 164, 961, 956, 596, 610, 765, 8, 217, 805, 427, 680, 247, 699, 848, 137, 870, 696, 660, 432, 593, 209, 327, 482, 708, 782, 520, 947, 390, 420, 456, 667, 544, 305, 220, 419, 608, 282, 269, 117, 834, 546, 137, 145, 128, 555, 299, 940, 971, 437, 79, 238, 497, 490, 912, 539, 157, 224, 556, 368, 551, 474, 291, 217, 1, 321, 17, 810, 411, 573, 688, 273, 701, 781, 761, 315, 895, 445, 467, 444, 925, 530, 50, 545, 970, 767, 953, 389, 393, 17, 668, 577, 803, 931, 829, 226, 114, 9, 239, 101, 419, 922, 17, 598, 704, 722, 768, 776, 156, 163, 419, 465, 206, 506, 891, 499, 992, 664, 270, 395, 519, 666, 37, 566, 251, 671, 474, 429, 776, 260, 319, 410, 772, 441, 340, 393, 452, 219, 487, 697, 993, 507, 515, 231, 988, 519, 435, 753, 177, 17, 341, 62, 361, 647, 939, 980, 7, 145, 113, 17, 585, 160, 75, 937, 163, 857, 233, 436, 973, 304, 140, 412, 521, 917, 233, 5, 649, 230, 513, 304, 745, 85, 799, 958, 983, 340, 745, 565, 835, 503, 558, 71, 518, 546, 439, 567, 870, 846, 519, 17, 945, 671, 390, 870, 347, 555, 234, 9, 134, 489, 608, 40, 291, 274, 690, 485, 633, 462, 490, 370, 740, 416, 125, 656, 679, 227, 455, 414, 227, 733, 787, 532, 879, 681, 148, 188, 426, 547, 21, 797, 73, 491, 27, 727, 912, 258, 572, 955, 585, 800, 357, 415, 389, 973, 738, 759, 968, 477, 192, 553, 398, 170, 834, 758, 10, 816, 676, 356, 78, 372, 322, 122, 590, 870, 911, 246, 452, 740, 199, 444, 738, 505, 498, 946, 675, 180, 957, 335, 222, 281, 625, 695, 173, 652, 141, 860, 842, 453, 809, 167, 308, 902, 101, 894, 834, 138, 301, 663, 9, 899, 948, 908, 74, 384, 454, 724, 4, 84, 949, 480, 961, 230, 367, 496, 289, 11, 139, 129, 255, 532, 607, 888, 812, 364, 105, 446, 612, 12, 374, 833, 19, 904, 153, 78, 267, 800, 285, 890, 618, 479, 648, 71, 53, 216, 686, 3, 498, 346, 739, 28, 760, 112, 725, 145, 133, 71, 737, 407, 228, 407, 619, 932, 296, 348, 166, 917, 317, 111, 263, 829, 418, 599, 304, 849, 442, 792, 880, 499, 719, 415, 853, 928, 47, 59, 679, 744, 590, 589, 90, 282, 568, 736, 383, 321, 481, 87, 831, 674, 430, 270, 393, 65, 864, 809, 922, 979, 461, 545, 738, 646, 539, 122, 992, 898, 497, 214, 393, 953, 503, 764, 143, 17, 385, 525, 49, 444, 108, 801, 866, 334, 120, 736, 971, 595, 754, 629, 331, 620, 252, 987, 846, 163, 219, 719, 231, 468, 734, 939, 220, 934, 170, 745, 635, 650, 550, 261, 346, 528, 303, 357, 878, 571, 755, 619, 661, 803, 335, 67, 496, 259, 25, 938, 649, 961, 975, 745, 312, 134, 253, 362, 716, 94, 62, 123, 429, 26, 590, 836, 485, 821, 924, 287, 837, 408, 924, 784, 382, 354, 255, 280, 537, 936, 524, 601, 495, 177, 148, 628, 776, 617, 278, 651, 767, 16, 66, 857, 956, 145, 817, 560, 906, 635, 526, 44, 981, 624, 446, 798, 796, 839, 941, 523, 990, 828, 537, 771, 251, 938, 884, 782, 866, 776, 255, 527, 709, 908, 659, 675, 694, 225, 603, 523, 617, 201, 85, 430, 982, 672, 713, 120, 237, 733, 723, 77, 765, 453, 296, 554, 770, 878, 569, 518, 360, 272, 602, 456, 614, 677, 593, 460, 51, 571, 422, 265, 974, 142, 82, 591, 542, 297, 516, 113, 198, 792, 244, 391, 737, 743, 741, 64, 688, 986, 588, 129, 4, 14, 397, 896, 832, 810, 656, 996, 618, 765, 887, 8, 226, 149, 884, 678, 358, 915, 956, 514, 995, 429, 969, 434, 955, 210, 672, 322, 404, 784, 884, 506, 984, 708, 757, 712, 195, 188, 326, 501, 524, 998, 972, 160, 857, 274, 807, 128, 313, 478, 804, 110, 974, 459, 801, 727, 595, 699, 800, 934, 798, 37, 191, 75, 486, 323, 477, 200, 360, 962, 179, 884, 985, 67, 145, 292, 191, 323, 213, 860, 700, 147, 334, 282, 267, 93, 867, 525, 492, 779, 691, 93, 710, 310, 97, 568, 708, 216, 780, 312, 438, 346, 327, 5, 756, 855, 261, 42]
# Sum:: 528823

# fix off-by-one
# Parts: [501, 168, 202, 332, 537, 697, 901, 609, 678, 261, 90, 870, 519, 449, 968, 273, 440, 415, 447, 883, 34, 651, 786, 646, 804, 96, 760, 222, 637, 290, 565, 518, 717, 80, 231, 610, 810, 942, 640, 499, 189, 550, 626, 676, 213, 432, 995, 955, 391, 387, 825, 362, 481, 579, 84, 506, 700, 170, 733, 658, 832, 777, 915, 322, 526, 852, 410, 14, 28, 831, 586, 69, 30, 505, 274, 344, 52, 308, 123, 504, 15, 968, 427, 439, 456, 935, 441, 195, 794, 786, 476, 168, 653, 148, 962, 271, 23, 435, 491, 4, 40, 26, 758, 957, 372, 894, 661, 283, 421, 946, 668, 886, 30, 682, 108, 292, 189, 759, 379, 380, 942, 891, 193, 946, 39, 847, 80, 886, 418, 763, 432, 873, 916, 335, 369, 651, 624, 445, 809, 695, 267, 666, 641, 888, 38, 685, 149, 312, 27, 544, 420, 750, 208, 361, 569, 986, 295, 751, 499, 549, 626, 390, 761, 319, 289, 250, 189, 947, 804, 742, 660, 342, 582, 611, 354, 997, 595, 874, 109, 108, 252, 168, 88, 973, 161, 499, 497, 52, 83, 5, 739, 156, 88, 798, 444, 974, 108, 39, 651, 395, 963, 911, 886, 417, 921, 82, 321, 597, 321, 409, 254, 237, 308, 954, 110, 478, 423, 990, 429, 506, 614, 893, 13, 811, 673, 85, 465, 393, 782, 166, 831, 401, 348, 477, 819, 261, 761, 536, 427, 924, 283, 795, 617, 954, 248, 407, 756, 986, 326, 516, 387, 336, 142, 354, 233, 523, 336, 495, 856, 363, 188, 177, 4, 512, 835, 458, 348, 445, 638, 214, 190, 293, 128, 711, 565, 842, 195, 984, 201, 530, 640, 289, 251, 626, 198, 277, 964, 397, 910, 936, 893, 249, 334, 299, 503, 918, 420, 405, 910, 892, 76, 511, 674, 282, 418, 962, 693, 760, 499, 908, 926, 906, 485, 564, 137, 300, 960, 503, 572, 490, 608, 979, 25, 925, 673, 433, 164, 961, 956, 596, 610, 765, 8, 217, 805, 427, 680, 247, 699, 848, 137, 870, 696, 660, 432, 593, 209, 327, 482, 708, 782, 520, 947, 390, 420, 456, 667, 544, 305, 220, 419, 608, 282, 269, 117, 834, 546, 137, 145, 128, 555, 299, 940, 971, 437, 79, 238, 497, 490, 912, 539, 157, 224, 556, 368, 551, 474, 217, 1, 321, 17, 810, 411, 573, 688, 273, 701, 781, 761, 315, 895, 445, 467, 444, 925, 530, 50, 545, 970, 767, 953, 389, 393, 17, 668, 577, 803, 931, 829, 226, 114, 9, 239, 101, 419, 922, 17, 598, 704, 722, 768, 776, 156, 163, 419, 465, 206, 506, 891, 499, 992, 664, 270, 395, 519, 666, 37, 566, 251, 671, 474, 429, 776, 260, 319, 410, 772, 441, 340, 393, 452, 219, 487, 697, 993, 507, 515, 231, 988, 519, 435, 753, 177, 17, 341, 62, 361, 647, 939, 980, 7, 145, 113, 17, 585, 160, 75, 937, 163, 857, 233, 436, 973, 304, 140, 412, 521, 917, 233, 5, 649, 230, 513, 304, 745, 85, 799, 958, 983, 340, 745, 565, 835, 503, 558, 71, 518, 546, 439, 567, 870, 846, 519, 17, 945, 671, 390, 870, 347, 555, 234, 9, 134, 489, 608, 40, 291, 274, 690, 485, 633, 462, 490, 370, 740, 416, 125, 656, 679, 227, 455, 414, 227, 733, 787, 532, 879, 681, 148, 188, 426, 547, 21, 797, 73, 491, 27, 727, 912, 258, 572, 955, 585, 800, 357, 415, 389, 973, 738, 759, 968, 477, 192, 553, 398, 170, 834, 758, 10, 816, 356, 78, 372, 322, 122, 590, 870, 911, 452, 740, 199, 444, 738, 505, 498, 946, 675, 180, 957, 335, 222, 281, 625, 695, 173, 652, 141, 860, 842, 453, 809, 167, 308, 902, 101, 894, 834, 138, 301, 663, 9, 899, 948, 908, 74, 384, 454, 724, 4, 84, 949, 480, 961, 230, 367, 496, 289, 11, 139, 129, 255, 532, 607, 888, 812, 364, 105, 612, 12, 374, 833, 19, 904, 153, 78, 267, 800, 285, 890, 618, 479, 648, 71, 53, 216, 686, 3, 498, 346, 739, 28, 760, 112, 725, 145, 133, 71, 737, 407, 228, 407, 619, 932, 296, 348, 166, 917, 317, 111, 263, 829, 418, 599, 304, 849, 442, 792, 880, 499, 719, 415, 853, 928, 47, 59, 679, 744, 590, 589, 90, 282, 568, 736, 383, 321, 481, 87, 831, 674, 430, 270, 393, 65, 864, 809, 922, 979, 461, 545, 738, 646, 539, 122, 992, 898, 497, 214, 393, 953, 503, 764, 143, 17, 385, 525, 49, 444, 108, 801, 866, 334, 120, 736, 971, 595, 754, 629, 331, 620, 252, 987, 846, 163, 219, 719, 231, 468, 734, 939, 220, 934, 170, 745, 635, 650, 550, 261, 346, 528, 303, 357, 878, 571, 755, 619, 661, 803, 335, 67, 496, 259, 25, 938, 649, 961, 975, 745, 312, 134, 253, 362, 716, 94, 62, 123, 429, 26, 590, 836, 485, 821, 924, 287, 837, 408, 924, 382, 354, 255, 280, 537, 936, 524, 601, 495, 177, 148, 628, 776, 617, 278, 651, 767, 16, 66, 857, 956, 145, 817, 560, 906, 635, 526, 44, 981, 624, 446, 798, 796, 839, 941, 523, 990, 828, 537, 771, 251, 938, 884, 782, 866, 776, 255, 527, 709, 908, 659, 675, 694, 225, 603, 523, 617, 201, 85, 430, 982, 672, 713, 120, 237, 733, 723, 77, 765, 453, 296, 554, 770, 878, 569, 518, 360, 272, 602, 456, 614, 677, 593, 51, 571, 422, 265, 974, 142, 82, 591, 542, 297, 516, 113, 198, 792, 244, 391, 737, 743, 741, 64, 688, 986, 588, 129, 4, 14, 397, 896, 832, 810, 656, 996, 618, 765, 887, 8, 226, 149, 884, 678, 358, 915, 956, 514, 995, 429, 969, 434, 955, 210, 672, 322, 404, 784, 884, 506, 984, 708, 757, 195, 188, 326, 501, 524, 998, 972, 160, 857, 274, 807, 128, 313, 478, 804, 110, 974, 459, 801, 727, 595, 699, 800, 934, 798, 37, 191, 75, 486, 323, 477, 200, 360, 962, 179, 884, 985, 67, 145, 292, 323, 213, 860, 700, 147, 334, 282, 267, 93, 867, 525, 492, 779, 691, 93, 710, 310, 97, 568, 708, 216, 780, 312, 438, 346, 327, 5, 855, 261, 42]
# Sum: 522726
